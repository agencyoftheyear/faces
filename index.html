<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Financeiro Estrat√©gico ‚Äî Cl√≠nica FACES</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked para renderizar Markdown do chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #0f172a;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --ai-purple: #7c3aed; /* Cor da IA */
            --brand-font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--brand-font);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 80px; /* Espa√ßo para o FAB */
        }

        /* --- HEADER & BADGE --- */
        header {
            background: var(--accent-blue);
            color: white;
            padding: 3rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.05em;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            font-weight: 300;
        }

        .agency-badge {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background-color: #ef4444;
            color: white;
            padding: 10px;
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            line-height: 1.2;
            letter-spacing: 1px;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: right;
        }

        /* --- LAYOUT GRID --- */
        #dashboard-content {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 1200px;
            margin: -2rem auto 0;
            padding: 0 1rem;
            position: relative;
            z-index: 5;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- KPI CARDS --- */
        .col-3 { grid-column: span 3; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-8 { grid-column: span 8; }
        .col-12 { grid-column: span 12; }

        @media (max-width: 768px) {
            .col-3, .col-4, .col-6, .col-8 { grid-column: span 12; }
            h1 { font-size: 1.8rem; }
            .agency-badge { display: none; }
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-blue);
        }

        .kpi-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }

        /* --- INSIGHT BOX --- */
        .insight-box {
            background-color: #f8fafc;
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .alert-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            background: #fee2e2;
            color: #ef4444;
            margin-bottom: 0.5rem;
        }

        /* --- TABLE --- */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th, td {
            text-align: left;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            font-weight: 600;
            color: var(--text-secondary);
            background-color: #f8fafc;
        }
        .profit-high { color: var(--accent-green); font-weight: bold; }
        .profit-mid { color: var(--accent-yellow); font-weight: bold; }
        .profit-low { color: var(--accent-red); font-weight: bold; }

        /* --- SIMULATIONS --- */
        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .sim-card {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .sim-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .sim-impact { color: var(--accent-green); font-weight: 800; font-size: 1.1rem; }

        /* --- RECOMMENDATIONS --- */
        .rec-list {
            list-style: none;
        }
        .rec-list li {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .rec-list li::before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-weight: bold;
        }

        /* --- AI FEATURES UI --- */
        .ai-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--ai-purple);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ai-fab:hover {
            transform: scale(1.05);
            background: #6d28d9;
        }

        /* Modal/Panel Styles */
        .ai-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 99;
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .ai-panel-header {
            background: var(--ai-purple);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-panel-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-panel-footer {
            padding: 15px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
        }

        .chat-btn {
            background: var(--ai-purple);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Chat Bubbles */
        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user {
            align-self: flex-end;
            background: var(--ai-purple);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            align-self: flex-start;
            background: white;
            color: var(--text-primary);
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 2px;
        }

        .message.system {
            align-self: center;
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 10px 0;
            text-align: center;
            width: 100%;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
            padding: 5px;
        }
        .dot {
            width: 6px;
            height: 6px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Markdown Styles inside chat */
        .message.ai strong { color: var(--ai-purple); }
        .message.ai ul { margin-left: 20px; margin-bottom: 10px; }
        .message.ai p { margin-bottom: 8px; }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .quick-btn {
            font-size: 0.75rem;
            padding: 5px 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--ai-purple);
        }
        .quick-btn:hover { background: #f3e8ff; }

    </style>
</head>
<body>

    <!-- CONTE√öDO DO DASHBOARD (Acesso Direto) -->
    <div id="dashboard-content">
        <!-- 1Ô∏è‚É£ CAPA EXECUTIVA -->
        <header>
            <div class="header-content">
                <h1>Relat√≥rio Financeiro Estrat√©gico</h1>
                <div class="subtitle">Cl√≠nica FACES ‚Äî An√°lise de Rentabilidade & Capacidade</div>
            </div>
            <div class="agency-badge">
                AGENCY<br>OF<br>THE<br>YEAR.<br><span style="font-weight:400; font-size:0.5rem; opacity:0.8;">Design Systems</span>
            </div>
        </header>

        <div class="container">

            <!-- 2Ô∏è‚É£ VIS√ÉO GERAL FINANCEIRA (KPIs) -->
            <div class="card col-3">
                <div class="card-title">Faturamento Total</div>
                <div class="kpi-value">R$ <span id="kpi-revenue"></span></div>
                <div class="kpi-sub">Receita bruta mensal</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Lucro Total</div>
                <div class="kpi-value text-green">R$ <span id="kpi-profit"></span></div>
                <div class="kpi-sub">L√≠quido ap√≥s despesas</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Margem L√≠quida</div>
                <div class="kpi-value text-green"><span id="kpi-margin"></span>%</div>
                <div class="kpi-sub">Sa√∫de financeira: Saud√°vel</div>
            </div>
            <div class="card col-3">
                <div class="card-title">Custo Total</div>
                <div class="kpi-value text-red">R$ <span id="kpi-cost"></span></div>
                <div class="kpi-sub">Operacional + Vari√°vel</div>
            </div>

            <!-- 3Ô∏è‚É£ AN√ÅLISE DE CUSTOS & PIZZA -->
            <div class="card col-4">
                <div class="card-title">Distribui√ß√£o do Faturamento</div>
                <canvas id="costsPieChart"></canvas>
                <div class="insight-box">
                    "Note que a fatia das Comiss√µes (30%) √© maior que o pr√≥prio Lucro da cl√≠nica (25%)."
                </div>
            </div>

            <div class="card col-8">
                <div class="card-title">Destino do Faturamento (Perspectiva de Lucro)</div>
                <canvas id="stackedBarChart" height="120"></canvas>
                <div style="margin-top: 15px; font-size: 0.9rem; color: #475569;">
                    <strong>Perspectiva Real:</strong> Observe a barra verde em rela√ß√£o ao todo. Para cada R$ 100,00 que entram na cl√≠nica, <strong>apenas R$ 25,00 permanecem como lucro real</strong>. O maior volume de sa√≠da (Laranja) s√£o as comiss√µes, que competem diretamente com a margem da empresa.
                </div>
            </div>

            <!-- 4Ô∏è‚É£ AN√ÅLISE DE PRODUTIVIDADE -->
            <div class="card col-6">
                <div class="card-title">Capacidade vs. Ociosidade</div>
                <div style="display: flex; align-items: center; justify-content: space-around;">
                    <div style="width: 180px;">
                        <canvas id="productivityChart"></canvas>
                    </div>
                    <div>
                        <div class="alert-badge">ALERTA DE EFICI√äNCIA</div>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--text-primary);">62%</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">da agenda dispon√≠vel n√£o foi utilizada.</div>
                        <br>
                        <div><strong>Horas Totais:</strong> <span id="hours-total"></span>h</div>
                        <div><strong>Horas Ociosas:</strong> <span id="hours-idle"></span>h</div>
                    </div>
                </div>
                <div class="insight-box">
                    "A cl√≠nica n√£o tem um problema grave de custos, mas um enorme potencial desperdi√ßado de agenda. O custo fixo est√° sendo dilu√≠do em poucas horas."
                </div>
            </div>

            <!-- 6Ô∏è‚É£ MATRIZ TEMPO √ó LUCRO -->
            <div class="card col-6">
                <div class="card-title">Matriz de Ouro: Tempo vs. Lucro</div>
                <canvas id="scatterChart"></canvas>
                <div class="insight-box">
                    <strong>Quadrante Superior Esquerdo:</strong> Procedimentos r√°pidos e lucrativos (Facetas, Limpezas).
                    <br><strong>Quadrante Inferior Direito:</strong> Procedimentos longos e de menor margem.
                </div>
            </div>

            <!-- 5Ô∏è‚É£ AN√ÅLISE POR PROCEDIMENTO (TABELA) -->
            <div class="card col-12">
                <div class="card-title">Rentabilidade por Procedimento (Top Performance)</div>
                <div class="table-container">
                    <table id="proceduresTable">
                        <thead>
                            <tr>
                                <th>Procedimento</th>
                                <th>Qtd</th>
                                <th>Receita Total</th>
                                <th>Custo Total</th>
                                <th>Tempo Total</th>
                                <th>Lucro L√≠quido</th>
                                <th>Margem</th>
                                <th>Classifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 7Ô∏è‚É£ SIMULA√á√ïES -->
            <div class="card col-12">
                <div class="card-title">Simula√ß√µes de Cen√°rio (What If)</div>
                <div class="simulation-grid">
                    <div class="sim-card">
                        <div class="sim-title">Cen√°rio A: +3 Facetas/m√™s</div>
                        <div class="sim-impact">+ R$ 1.650,00 Lucro</div>
                        <p style="font-size: 0.8rem; color: #64748b;">Utilizando apenas 1h 45min da ociosidade atual.</p>
                    </div>
                    <div class="sim-card">
                        <div class="sim-title">Cen√°rio B: Ocupar 50% da Ociosidade</div>
                        <div class="sim-impact">+ R$ 6.200,00 Lucro</div>
                        <p style="font-size: 0.8rem; color: #64748b;">Considerando mix atual de servi√ßos. Margem subiria para 32%.</p>
                    </div>
                    <div class="sim-card">
                        <div class="sim-title">Cen√°rio C: Redu√ß√£o Taxa Cart√£o (2%)</div>
                        <div class="sim-impact">+ R$ 450,00/m√™s</div>
                        <p style="font-size: 0.8rem; color: #64748b;">Ajuste financeiro simples sem esfor√ßo cl√≠nico.</p>
                    </div>
                </div>
            </div>

            <!-- 8Ô∏è‚É£ & 9Ô∏è‚É£ DIAGN√ìSTICO E RECOMENDA√á√ïES -->
            <div class="card col-6">
                <div class="card-title">Diagn√≥stico Final</div>
                <ul class="rec-list">
                    <li><strong>Depend√™ncia de Comiss√µes:</strong> Modelo de repasse (30%) √© alto. Em procedimentos de baixo valor agregado, o lucro da cl√≠nica fica comprimido.</li>
                    <li><strong>Ociosidade Cr√≠tica:</strong> Com 108 horas livres, a cl√≠nica est√° pagando aluguel e custos fixos para manter a sala vazia na maior parte do tempo.</li>
                    <li><strong>Mix de Produtos:</strong> Facetas e Limpezas sustentam a rentabilidade. Procedimentos longos como Clareamento de Consult√≥rio (3h) entregam margem menor por hora.</li>
                </ul>
            </div>
            <div class="card col-6" style="background-color: #f0fdf4; border: 1px solid #bbf7d0;">
                <div class="card-title" style="color: #166534;">Recomenda√ß√µes Estrat√©gicas</div>
                <ul class="rec-list" style="color: #14532d;">
                    <li><strong>Curto Prazo (30 dias):</strong> Campanha focada em preencher "buracos" na agenda com Limpezas (procedimento √¢ncora de alta margem/hora).</li>
                    <li><strong>M√©dio Prazo:</strong> Revisar precifica√ß√£o de procedimentos que levam mais de 2 horas.</li>
                    <li><strong>Estrutural:</strong> Negociar taxa escalonada de comiss√£o (ex: 25% base + 5% b√¥nus por meta) para proteger a margem da cl√≠nica.</li>
                </ul>
            </div>

        </div>
    </div>

    <!-- AI FAB & PANEL -->
    <div class="ai-fab" id="aiFab" onclick="toggleAiPanel()">
        <span>‚ú® Consultor IA</span>
    </div>

    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <span>ü§ñ CFO Virtual Cl√≠nica FACES</span>
            <span onclick="toggleAiPanel()" style="cursor:pointer; opacity: 0.7;">‚úñ</span>
        </div>
        <div class="ai-panel-body" id="chatBody">
            <div class="message system">Conectado ao Gemini 2.5 Flash</div>
            <div class="message ai">
                Ol√°! Sou o assistente financeiro inteligente da Cl√≠nica FACES. <br><br>
                Tenho acesso a todos os seus dados de faturamento, custos e ociosidade. Como posso ajudar a aumentar seu lucro hoje?
            </div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="askAi('Gere um relat√≥rio executivo resumido')">üìù Gerar Relat√≥rio</button>
                <button class="quick-btn" onclick="askAi('Como reduzir a ociosidade?')">üìâ Reduzir Ociosidade</button>
                <button class="quick-btn" onclick="askAi('Analise minha margem de lucro')">üí∞ Analisar Margem</button>
            </div>
        </div>
        <div class="ai-panel-footer">
            <div class="chat-input-group">
                <input type="text" id="aiInput" class="chat-input" placeholder="Pergunte sobre os n√∫meros..." onkeypress="handleEnter(event)">
                <button class="chat-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // --- GEMINI API SETUP ---
        const apiKey = ""; // Set by environment
        const modelId = "gemini-2.5-flash-preview-09-2025";

        // --- DADOS ATUALIZADOS ---
        const summaryData = {
            revenue: 30910,      
            fixedExpenses: 5393, 
            materials: 4041,     
            commissions: 9403,   
            taxes: 2472,         
            cardFees: 1828,      
            totalProfit: 7771,   
            totalCost: 23138,    
            totalHours: 176,
            usedHours: 67.17,
            idleHours: 108.83
        };

        const proceduresData = [
            { name: "Clareamento Caseiro", qty: 2, price: 780, totalRevenue: 1560, totalCost: 1092, timeMin: 120, totalTimeH: 4, profit: 468 },
            { name: "Clareamento Consult√≥rio", qty: 2, price: 1000, totalRevenue: 2000, totalCost: 1400, timeMin: 180, totalTimeH: 6, profit: 600 },
            { name: "Endodontia", qty: 2, price: 650, totalRevenue: 1300, totalCost: 910, timeMin: 90, totalTimeH: 3, profit: 390 },
            { name: "Facetas", qty: 20, price: 550, totalRevenue: 11000, totalCost: 6501, timeMin: 35, totalTimeH: 11.67, profit: 4499 },
            { name: "Limpeza", qty: 20, price: 280, totalRevenue: 5600, totalCost: 3108, timeMin: 30, totalTimeH: 10, profit: 2492 },
            { name: "Manut. Orto Conv.", qty: 15, price: 110, totalRevenue: 1650, totalCost: 862, timeMin: 30, totalTimeH: 7.5, profit: 788 },
            { name: "Rest. Grande", qty: 15, price: 280, totalRevenue: 4200, totalCost: 2185, timeMin: 60, totalTimeH: 15, profit: 2015 },
            { name: "Rest. Pequena", qty: 20, price: 180, totalRevenue: 3600, totalCost: 2350, timeMin: 30, totalTimeH: 10, profit: 1250 }
        ];

        // --- AI LOGIC ---
        function toggleAiPanel() {
            const panel = document.getElementById('aiPanel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                // Scroll to bottom
                const body = document.getElementById('chatBody');
                body.scrollTop = body.scrollHeight;
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function askAi(text) {
            document.getElementById('aiInput').value = text;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if (!text) return;

            // 1. Add User Message
            addMessage(text, 'user');
            input.value = '';

            // 2. Add Loading Indicator
            const loadingId = addLoading();

            // 3. Prepare Prompt
            const context = `
                Voc√™ √© um CFO Virtual experiente da Cl√≠nica Odontol√≥gica FACES.
                
                DADOS DO M√äS:
                - Faturamento: R$ ${summaryData.revenue}
                - Lucro L√≠quido: R$ ${summaryData.totalProfit} (Margem: 25.14%)
                - Custos Totais: R$ ${summaryData.totalCost}
                - Comiss√µes Dentistas: R$ ${summaryData.commissions} (30% do faturamento)
                - Ociosidade: ${summaryData.idleHours} horas (${((summaryData.idleHours/summaryData.totalHours)*100).toFixed(1)}% da agenda)
                
                DETALHE PROCEDIMENTOS (Top Performance):
                ${JSON.stringify(proceduresData.map(p => ({n: p.name, l: p.profit, m: ((p.profit/p.totalRevenue)*100).toFixed(1)+'%'})))}

                INSTRU√á√ÉO:
                Responda √† pergunta do usu√°rio com base nesses n√∫meros. Seja estrat√©gico, curto e use formata√ß√£o Markdown (negrito, listas). Foque em lucro e efici√™ncia.
                Pergunta: "${text}"
            `;

            try {
                // 4. Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: context }] }]
                    })
                });

                if (!response.ok) throw new Error('Falha na API');

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // 5. Remove Loading & Add AI Message
                removeLoading(loadingId);
                addMessage(aiText, 'ai');

            } catch (error) {
                removeLoading(loadingId);
                addMessage("Desculpe, tive um problema ao analisar os dados. Tente novamente.", 'ai');
                console.error(error);
            }
        }

        function addMessage(text, type) {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            if (type === 'ai') {
                div.innerHTML = marked.parse(text);
            } else {
                div.textContent = text;
            }
            
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        function addLoading() {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.className = 'message ai loading-dots';
            div.id = 'loading-' + Date.now();
            div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
            return div.id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- DASHBOARD INIT (AUTO START) ---
        window.onload = function() {
            initDashboard();
        };

        function initDashboard() {
            // Populate Fields
            document.getElementById('kpi-revenue').textContent = summaryData.revenue.toLocaleString('pt-BR');
            document.getElementById('kpi-profit').textContent = summaryData.totalProfit.toLocaleString('pt-BR');
            document.getElementById('kpi-margin').textContent = "25,14"; 
            document.getElementById('kpi-cost').textContent = summaryData.totalCost.toLocaleString('pt-BR');
            document.getElementById('hours-total').textContent = summaryData.totalHours;
            document.getElementById('hours-idle').textContent = summaryData.idleHours.toLocaleString('pt-BR');

            // Charts
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';

            // Pie
            new Chart(document.getElementById('costsPieChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Lucro L√≠quido', 'Comiss√µes', 'Despesas Fixas', 'Materiais', 'Impostos', 'Taxas Cart√£o'],
                    datasets: [{
                        data: [summaryData.totalProfit, summaryData.commissions, summaryData.fixedExpenses, summaryData.materials, summaryData.taxes, summaryData.cardFees],
                        backgroundColor: ['#10b981', '#f59e0b', '#64748b', '#3b82f6', '#ef4444', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });

            // Bar
            new Chart(document.getElementById('stackedBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Faturamento (100%)'],
                    datasets: [
                        { label: 'Lucro L√≠quido', data: [summaryData.totalProfit], backgroundColor: '#10b981' },
                        { label: 'Comiss√µes', data: [summaryData.commissions], backgroundColor: '#f59e0b' },
                        { label: 'Fixos', data: [summaryData.fixedExpenses], backgroundColor: '#64748b' },
                        { label: 'Materiais', data: [summaryData.materials], backgroundColor: '#3b82f6' },
                        { label: 'Impostos/Taxas', data: [summaryData.taxes + summaryData.cardFees], backgroundColor: '#ef4444' }
                    ]
                },
                options: { indexAxis: 'y', responsive: true, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, display: false } }, plugins: { legend: { position: 'bottom' } } }
            });

            // Productivity
            new Chart(document.getElementById('productivityChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Ocioso', 'Produtivo'],
                    datasets: [{ data: [summaryData.idleHours, summaryData.usedHours], backgroundColor: ['#e2e8f0', '#0f172a'], hoverOffset: 4 }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });

            // Scatter
            const scatterData = proceduresData.map(proc => ({
                x: proc.timeMin, y: proc.profit / proc.qty, procedure: proc.name
            }));
            new Chart(document.getElementById('scatterChart').getContext('2d'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Procedimentos', data: scatterData, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10b981', pointRadius: 6 }] },
                options: {
                    responsive: true,
                    scales: { x: { title: { display: true, text: 'Tempo (min)' } }, y: { title: { display: true, text: 'Lucro Unit. (R$)' } } },
                    plugins: { tooltip: { callbacks: { label: function(c) { return c.raw.procedure + ': R$ ' + c.raw.y.toFixed(2); } } } }
                }
            });

            // Table
            const tableBody = document.querySelector('#proceduresTable tbody');
            tableBody.innerHTML = '';
            proceduresData.sort((a, b) => b.profit - a.profit).forEach(proc => {
                const margin = (proc.profit / proc.totalRevenue) * 100;
                let classification = margin > 30 ? "üü¢ Alta Rentabilidade" : (margin > 20 ? "üü° Moderado" : "üî¥ Baixa/Risco");
                let classColor = margin > 30 ? "profit-high" : (margin > 20 ? "profit-mid" : "profit-low");
                tableBody.innerHTML += `<tr><td>${proc.name}</td><td>${proc.qty}</td><td>R$ ${proc.totalRevenue.toLocaleString('pt-BR')}</td><td>R$ ${proc.totalCost.toLocaleString('pt-BR')}</td><td>${proc.totalTimeH.toFixed(1)} h</td><td class="${classColor}">R$ ${proc.profit.toLocaleString('pt-BR')}</td><td>${margin.toFixed(1)}%</td><td>${classification}</td></tr>`;
            });
        }
    </script>
</body>
</html>
